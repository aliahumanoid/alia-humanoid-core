# Joint Configuration Synchronization

## Problem Statement

Previously, joint definitions (IDs, DOF counts, angle limits) were **duplicated** between:
- **Firmware**: `firmware/joint_controller/include/config_presets.h` (C++)
- **Host**: `host/config.py` (Python)

This duplication caused **critical issues**:
1. ❌ **Configuration drift**: Firmware and host had different angle limits
2. ❌ **Missing DOF**: Host thought HIP had 2 DOF, but firmware has 3 DOF
3. ❌ **Safety risks**: Incorrect limits could violate mechanical constraints
4. ❌ **Manual sync burden**: Every firmware change required manual host update

## Solution: Single Source of Truth

We implemented an **automatic synchronization system** where:
- **Firmware** (`config_presets.h`) is the **single source of truth**
- **Python script** extracts configuration and generates **JSON**
- **Host** loads configuration from **JSON** at runtime
- **Makefile** automatically regenerates JSON when firmware changes

### Architecture

```
┌─────────────────────────────────────┐
│   config_presets.h (C++)            │ ← SINGLE SOURCE OF TRUTH
│   (firmware configuration)          │   (edit here to change configs)
└──────────┬──────────────────────────┘
           │
           │ (1) Parse with Python script
           ▼
┌─────────────────────────────────────┐
│  extract_joint_config.py            │
│  (Python parser)                    │
└──────────┬──────────────────────────┘
           │
           │ (2) Generate JSON
           ▼
┌─────────────────────────────────────┐
│  joint_config.json                  │ ← GENERATED (do not edit manually!)
│  (intermediate format)              │
└──────────┬──────────────────────────┘
           │
           │ (3) Load at runtime
           ▼
┌─────────────────────────────────────┐
│  config.py (Python)                 │
│  JOINTS, MIN_ANGLES, MAX_ANGLES     │ ← Auto-populated from JSON
└─────────────────────────────────────┘
```

## Usage

### Fully Automatic (Recommended)

**The JSON is automatically regenerated whenever you build the firmware!**

When you compile `joint_controller` firmware (via Cursor UI button, PlatformIO CLI, or Makefile), the post-build script automatically runs and regenerates `joint_config.json`.

```bash
# Option 1: Build from Cursor (recommended)
# Click the checkmark button in footer → JSON auto-generated ✓

# Option 2: Build via Makefile
cd software
make fw-build-controller ENV=pico2  # → Regenerates JSON automatically

# Option 3: Build via PlatformIO CLI
cd software/firmware/joint_controller
pio run -e pico2  # → Regenerates JSON automatically
```

### Automatic via Makefile

The Makefile also regenerates `joint_config.json` if `config_presets.h` is newer when running the host:

```bash
# Just run the host app - JSON regenerates if needed
cd software
make host-run
```

### Manual

To manually regenerate the JSON:

```bash
# Option 1: Using Makefile
cd software
make joint-config

# Option 2: Using script directly
cd software
python3 scripts/extract_joint_config.py
```

## How to Update Joint Configurations

1. **Edit the firmware config** (single source of truth):
   ```bash
   vim software/firmware/joint_controller/include/config_presets.h
   ```

2. **Build the firmware** (JSON auto-regenerates):
   ```bash
   # Click the build button in Cursor
   # OR: cd software && make fw-build-controller ENV=pico
   # → JSON automatically regenerated by post-build script ✓
   ```

3. **Restart host application** to load new config:
   ```bash
   make host-run
   ```

**That's it!** The post-build script ensures firmware builds always sync the JSON.

## Files

| File | Role | Edit? |
|------|------|-------|
| `firmware/joint_controller/include/config_presets.h` | **Single source of truth** | ✅ YES |
| `firmware/joint_controller/scripts/generate_joint_config.py` | Post-build hook (PlatformIO) | Only if build integration changes |
| `scripts/extract_joint_config.py` | Parser/generator | Only if parsing logic changes |
| `joint_config.json` | Generated intermediate format | ❌ NO (auto-generated) |
| `host/config.py` | Loads JSON and exposes API | Only for non-joint configs |
| `firmware/joint_controller/platformio.ini` | Build config with post-build hook | Only for build settings |

## What Gets Synchronized

For each joint, the following data is synchronized:

- **Joint ID** (e.g., `KNEE_LEFT` = 1)
- **Joint name** (e.g., "Left Knee")
- **DOF count** (e.g., 1, 2, or 3)
- **Motor count** (e.g., 2, 4, or 6)
- **For each DOF**:
  - DOF index (0, 1, 2)
  - DOF name (e.g., "flexion-extension")
  - Min angle (degrees)
  - Max angle (degrees)
  - Encoder channel

## Example: Joint Config JSON

```json
{
  "version": "1.0",
  "source": "config_presets.h",
  "joints": {
    "knee_left": {
      "id": 1,
      "dof_count": 1,
      "motor_count": 2,
      "dofs": [
        {
          "index": 0,
          "name": "flexion_extension",
          "min_angle": -30.0,
          "max_angle": 90.0,
          "encoder_channel": 0
        }
      ]
    },
    "hip_left": {
      "id": 5,
      "dof_count": 3,
      "motor_count": 6,
      "dofs": [
        {
          "index": 0,
          "name": "flexion_extension",
          "min_angle": -30.0,
          "max_angle": 120.0,
          "encoder_channel": 0
        },
        {
          "index": 1,
          "name": "abduction_adduction",
          "min_angle": -45.0,
          "max_angle": 45.0,
          "encoder_channel": 1
        },
        {
          "index": 2,
          "name": "internal_external_rotation",
          "min_angle": -40.0,
          "max_angle": 40.0,
          "encoder_channel": 2
        }
      ]
    }
  }
}
```

## Python API (host/config.py)

The host application loads the JSON and exposes these variables:

```python
from config import JOINTS, MIN_ANGLES, MAX_ANGLES

# JOINTS dictionary
JOINTS = {
    'KNEE_LEFT': {
        'id': 1,
        'name': 'Left Knee',
        'dofs': [{'index': 0, 'name': 'flexion-extension'}]
    },
    'HIP_LEFT': {
        'id': 5,
        'name': 'Left Hip',
        'dofs': [
            {'index': 0, 'name': 'flexion-extension'},
            {'index': 1, 'name': 'abduction-adduction'},
            {'index': 2, 'name': 'internal-external-rotation'}
        ]
    },
    # ...
}

# MIN_ANGLES (scalar for 1 DOF, dict for multi-DOF)
MIN_ANGLES = {
    'KNEE_LEFT': -30.0,  # Single DOF
    'HIP_LEFT': {0: -30.0, 1: -45.0, 2: -40.0},  # 3 DOF
    # ...
}

# MAX_ANGLES (scalar for 1 DOF, dict for multi-DOF)
MAX_ANGLES = {
    'KNEE_LEFT': 90.0,  # Single DOF
    'HIP_LEFT': {0: 120.0, 1: 45.0, 2: 40.0},  # 3 DOF
    # ...
}
```

## Naming Conventions

| Firmware (C++) | JSON | Host (Python) |
|----------------|------|---------------|
| `KNEE_LEFT_CONFIG` | `"knee_left"` | `JOINTS['KNEE_LEFT']` |
| `.name = "knee_left"` | `"config_name": "knee_left"` | `'name': "Left Knee"` |
| `.dofs[0].name = "flexion_extension"` | `"name": "flexion_extension"` | `'name': "flexion-extension"` |

**Transformations**:
- Firmware → JSON: As-is (snake_case)
- JSON → Host: `UPPER_CASE` keys, hyphenated DOF names

## Benefits

✅ **No configuration drift**: Firmware and host always synchronized  
✅ **Single source of truth**: Edit config in one place (firmware)  
✅ **Fully automatic**: JSON regenerates on every firmware build (post-build hook)  
✅ **Zero developer action**: Build firmware → JSON updates automatically  
✅ **Makefile integration**: Also regenerates when running host via make  
✅ **Type safety**: JSON schema validates structure  
✅ **Build-time check**: Missing JSON fails fast with clear error  
✅ **Zero runtime overhead**: JSON loaded once at startup  
✅ **Maintainable**: Future joint additions require zero host code changes  

## Troubleshooting

### Error: `FileNotFoundError: Joint configuration file not found`

**Cause**: `joint_config.json` is missing

**Solution**:
```bash
cd software
make joint-config
```

### Error: Parse failure when running script

**Cause**: C++ syntax in `config_presets.h` changed and script regex can't parse it

**Solution**: Update `scripts/extract_joint_config.py` regex patterns to match new syntax

### Host loads old configuration

**Cause**: Host application caches imported modules (Python behavior)

**Solution**: Restart the host application after regenerating JSON

## Future Enhancements

Potential improvements for future development:

1. **Firmware runtime query**: Host could query firmware for config via serial command
2. **Bidirectional validation**: Script could validate firmware config against constraints
3. **Auto-formatting**: Script could format C++ config with clang-format
4. **CI integration**: Fail PR if JSON not regenerated after config change
5. **Version tracking**: Detect firmware/host version mismatch

## Related Files

- `software/firmware/joint_controller/include/config_presets.h` - Firmware config
- `software/scripts/extract_joint_config.py` - Parser script
- `software/joint_config.json` - Generated JSON
- `software/host/config.py` - Host configuration
- `software/Makefile` - Build automation
- `software/docs/JOINT_CONFIG_SYNC.md` - This document

## Commit History

This synchronization system was implemented to resolve critical configuration drift
discovered during software refactoring phase (October 2025).

**Key commits**:
- Joint config synchronization implementation
- Automatic Makefile integration
- Documentation

**Before**: Manual sync, 6 mismatched configs, missing HIP DOF 2  
**After**: Automated sync, 0 mismatches, full 3-DOF HIP support

